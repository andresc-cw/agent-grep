#!/usr/bin/env bash
set -euo pipefail

# sg — search Claude Code & Codex sessions, pick one with fzf, resume it
#
# Usage:
#   sg<search terms>          Search sessions and pick one to resume
#   sg--list                  Browse all sessions, type to search content
#   sg--update                Re-index sessions before searching

SESSION_DIR="$HOME/.cache/agent-grep/sessions"
# Resolve symlinks so SCRIPT_DIR points to the repo, not the symlink location
SELF="$0"
[[ -L "$SELF" ]] && SELF="$(readlink "$SELF")"
SCRIPT_DIR="$(cd "$(dirname "$SELF")" && pwd)"

# ── Search helper ───────────────────────────────────────────────────────
#
# Written to a temp file so fzf's change:reload can call it.
# Uses rg for content search + gawk for fast frontmatter formatting.
# gawk is required (macOS /usr/bin/awk lacks ENDFILE): brew install gawk

AWK_FMT="$SCRIPT_DIR/.sg_fmt.awk"

HELPER=$(mktemp "${TMPDIR:-/tmp}/sg-helper.XXXXX")
trap 'rm -f "$HELPER"' EXIT

cat > "$HELPER" << HELPEREOF
#!/usr/bin/env bash
QUERY="\$1"
if [[ -z "\$QUERY" ]]; then
    gawk -f "$AWK_FMT" "$SESSION_DIR"/*.md 2>/dev/null
else
    matches=\$(rg -l --no-messages -i -- "\$QUERY" "$SESSION_DIR"/*.md)
    if [[ -n "\$matches" ]]; then
        echo "\$matches" | xargs gawk -f "$AWK_FMT" 2>/dev/null
    fi
fi
HELPEREOF
chmod +x "$HELPER"

# ── Handle flags ────────────────────────────────────────────────────────

if [[ "${1:-}" == "--update" ]]; then
    "$SCRIPT_DIR/session2md.sh"
    shift
    [[ $# -eq 0 ]] && exit 0
fi

INITIAL_QUERY=""
if [[ "${1:-}" == "--list" ]]; then
    INITIAL_QUERY=""
elif [[ $# -gt 0 ]]; then
    INITIAL_QUERY="$*"
else
    echo "Usage: sg <search terms>"
    echo "       sg --list"
    echo "       sg --update [search terms]"
    exit 1
fi

# ── Run search + fzf ───────────────────────────────────────────────────

# Get initial results (all sessions or pre-filtered)
initial=$(bash "$HELPER" "$INITIAL_QUERY")

if [[ -z "$initial" && -n "$INITIAL_QUERY" ]]; then
    echo "No sessions found for: $INITIAL_QUERY"
    exit 1
fi

# fzf with live content search: typing re-runs rg across session files
selected=$(echo "$initial" | fzf \
    --disabled \
    --query "$INITIAL_QUERY" \
    --bind "change:reload:bash '$HELPER' {q}" \
    --delimiter=$'\t' \
    --with-nth=4 \
    --preview="head -50 '$SESSION_DIR'/{2}-{1}.md" \
    --preview-window=right:50%:wrap \
    --header="Type to search session content (Enter=open, Esc=cancel)")

[[ -z "$selected" ]] && exit 0

# ── Extract and resume ──────────────────────────────────────────────────

session_id=$(echo "$selected" | cut -f1)
agent=$(echo "$selected" | cut -f2)
project_dir=$(echo "$selected" | cut -f3)

# claude --resume is project-scoped: it only finds sessions for the cwd's project
if [[ -n "$project_dir" && -d "$project_dir" ]]; then
    cd "$project_dir"
fi

if [[ "$agent" == "claude" ]]; then
    exec claude --resume "$session_id"
else
    exec codex --resume "$session_id"
fi
